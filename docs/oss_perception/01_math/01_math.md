# 数学
## 回転と並進
三次元空間の運動は、回転、並進のみで表現出来ることが多く、
例えば、人の動きは回転のみで割と表現できます。それらの値を推定したり、
うまく扱うことは、空間認識を作る上で重要です。

### 回転の表現方法
回転を表現する方法として、

三次元の回転情報を"格納"する構造として、
オイラー角、回転ベクトル、quaternion、リー代数、回転行列などがある。この内、リー代数は回転を変数とした一般的な最適化問題を解くのに役立つ。
オイラー角、回転ベクトルは直感的に表現できるが、回転ゼロが不定値となり、回転を連続して表現できない。

オイラー角と似たようなものに、Tait-Bryan anglesという角度もあり、
Tait-Bryan anglesがオイラー角として説明されていることもある。

quaternionと回転行列は全ての回転を連続して表現できるが、
回転行列はパラメータ数が多く、quaternionは少ないパラメータで表現できる。
それぞれのいいところを活かしつつ、使い分ける必要がある。

特にquaternionは、デバッグできる程度に理解しておく必要がある。

単位四元数は少なくとも一つ以上？の角度と単位ベクトルで表せる。
これをベクトルaの右から共役四元数、左から四元数をかけると、回転軸を角度分回転させたものになる。イメージ的には単位複素数を使った回転を謎の四次元空間でやってるだけ。でも、そのまま演算ルールを適用すると計算できるので0回転も表せる。

qからRは一意な変換ができる。
逆はできないので、if文とかで分岐して実装。

回転行列の補正は、推定した回転を特異値分解する。

回転をパラメータ化すると、特異点が理論上できてしまうが、リー代数を使えば、特異点を全く気にする必要がない。なので回転をパラメータにした一般的な最適化問題で使いやすい。

オイラー角やRPY表記が曖昧に記載されていることが多く、
どのような角度か、ドキュメント外から、推測したりする必要もある。

### 座標変換と実装上のコツ

### 三次元点のペアから運動を推定
また、点が複数用意された場合に、それらの点の集合の間の回転を推定することもできます。
三次元点が3点あり、それが正規直交基底である場合、$R = R_2 R_1^{-1}`$で求めることができる。
正規直交基底でない場合、もしくは2点のみの場合は、正規直交基底を構築してから、

コンビジョンでは、は誤差があるので、誤差を考慮した手法を用いて運動を推定する。
誤差が一様、独立、等方な正規分布に従う場合は、特異値分解で解くことができる。
scipyには、`align_vectors`というメソッドがあり、このメソッドを使えば、ベクトルのリストを2つ用意するのみで、回転を求められる。この手法は２つのベクトル集合の相関行列を求め、その相関行列の特異値分解より求まる。
ちなみにこの手法はKabsch methodと呼ばれている。C++では、次のように実装できる。

!!! todo
    scipyのalign_vectorsを理解する。

実際は、センサの誤差の出方はXYZで異なることが多く、
そういった場合にはFNS法と呼ばれる方法で、回転を推定できる。
実際のデバイスでは、次のような違い非等方性が想定できる。
非等方性の誤差は多変数ガウス分布で表現できて、多変数ガウス分布は共分散行列がパラメータである。
分布の共分散行列の固有ベクトルのうち固有値が最も高いものは最も誤差が大きい軸、
固有値が最も小さいものは誤差が小さい軸である。

### 方向ベクトルの計算
方向を表現したベクトル間の回転を求める方法ですが、
何かの方向が方向ベクトルのみで表せられる場合は、
その2つの方向ベクトルの最小回転の回転軸と角度を外積で求められる。

### 二次元点と三次元点から運動を推定
## 三次元と二次元の関係
